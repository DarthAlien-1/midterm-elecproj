name: Auto-Commit Image Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'input_images/**'  
      - 'processor.py'      

permissions:
  contents: write          

jobs:
  process-and-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }} # Use the permission token

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install opencv-python-headless numpy

    - name: Run Image Processor
      run: python processor.py

    - name: Commit and Push Changes
      run: |
        # 1. Confirm git user
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # 2. Add the output folder
        git add output_images/
        
        # 3. Commit if there are changes
        # The '|| exit 0' prevents the pipeline from failing if nothing changed
        git commit -m "Auto-processed images by DevOps Pipeline" || exit 0
        
        # 4. Push back to repo
        git push
